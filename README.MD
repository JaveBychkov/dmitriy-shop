Корзина Товаров
=====

Простое приложение которое представляет из себя корзину товаров. Как зарегистрированный так и не зарегистрированный пользователь может добавлять товары в корзину, удалять товары из корзины, а также изменять количество товаров в корзине.
Разработчик, по своему усмотрению, может включить уведомления для пользователя на случай если цена товара в корзине изменится.

Установка
-----------
```
$ git clone https://github.com/JaveBychkov/django-dmitriy-shoppingcart.git folder && cd folder
$ pip install .
```

Быстрый старт
-----------
-  Добавить указатель на модель товара в settings.py:

```python
PRODUCT_MODEL = 'myApp.Product'
```
 - Приложение предполагает, что у вашей модели товара определены следующие методы:
  -- `get_price()` - Метод возвращающий окончательную цену товара.
  -- `in_stock()` - Метод возвращающий `True` если товар есть в наличии и `False` если нет.

- Добавить приложение в INSTALLED_APPS:
```python
INSTALLED_APPS = [
        ...
        'shoppingcart.apps.ShoppingcartConfig',
]
```

- Подключить кофигурацию URL в urls.py вашего проекта:
```python
path('cart/', include('shoppingcart.urls')),
```
- Необходимо создать миграции, так как приложение зависит от модели товара определенной вне приложения:
```python
python manage.py makemigrations shoppingcart
python manage.py migrate
```
- Можно запускать сервер.

Работа с корзиной
-----------
По умолчанию корзина доступна как для зарегистрированных пользователей так и для гостей по адресу `/cart/detail/`. По умолчанию шаблон корзины ожидает от модели продукта такие поля как `image`, `title` и `slug`.
На странице корзины пользователь может удалить товар из корзины или изменить количество товара в корзине.

[Шаблон можно переписать и использовать свой](https://docs.djangoproject.com/en/2.0/howto/overriding-templates/) 

Для `/cart/detail/` используется шаблон с стандартным названием для `generic.DeatilView`:  `cart_detail.html` 
В контекст шаблона передается модель корзины товаров, для доступа к ее позициями необходимо обратиться к связанным объектам позиций (Не требует дополнительных запросов к базе): `object.line_set.all` 
Модель позиции имеет следующие атрибуты:
-  `product` - Связанная модель продукта.
-  `cart` - Связанная модель корзины товаров.
-  `final_price` - Окончательная цена позиции, может быть blank и null
-  `price_changed` - Boolean значение показывающие была ли изменена цена связанного товара. (Необходимы дополнительные действия, о них ниже)
- `quantity` - Количество товара.
И Один метод:
- `total_price()` - Возвращает цену товара умноженную на количество `product.get_price()` * `quantity`

Кроме этого в контекст шаблона передается переменная `total` которая равна сумме цен всех товаров в корзине и переменная `price_changed` (True or Flase) которая показывает была ли изменена цена для одного или более товаров в корзине. 

- Для добавления продуктов в корзину необходимо отправить POST ajax запрос на адерс `/cart/add_product/` содержащий в себе следующие данные : `id_` - id товара и `slug` - slug товара.
Пример данных:
```javascript
{"id_": 10, "slug": "some-slug"}
```

- Для удаления продукта из корзины необходимо отправить POST ajax запрос на адерс `/cart/remove_product/` содержащий в себе следующие данные : `id_` - id товара и `slug` - slug товара.
Пример данных:
```javascript
{"id_": 10, "slug": "some-slug"}
```

- Для изменения количества товара в корзине необходимо отправить POST ajax запрос на адерс `/cart/price_changed/` содержащий в себе следующие данные : `id_` - id товара, `slug` - slug товара и `quantity` - новое количество товара.
Пример данных:
```javascript
{"id_": 10, "slug": "some-slug", "quantity": 3}
```

Если вы хотите уведомить пользователя об изменении цен на товары в его корзине, то в приложении доступен сигнал:
```python
from shoppingcart.signals import price_changed
```
Который в качестве аргумента ожидает объект товара, после отправки сигнала у всех позиций во всех корзинах которые имеют этот товар будет изменен аттрибут `price_changed` на True. 

Если используется реализация по умолчанию то после отправки сигнала, на странице корзины пользователя, который имеет в корзине товар с измененной ценой, будет отображаться уведомление о том, что цена на один или более товаров в его корзине  была изменена и кнопка с "потверждением об осведомлении". При нажатии на кнопку будет отправлен POST ajax запрос на адрес `cart/price-changed/` с следующими данными `{"confirm": true}` если `confirm is True` аттрибут `price_changed` всех позиций в корзине пользователя будет изменен на `False` и при следующем открытии страницы корзины уведомление отображаться не будет. 

Пример использования сигнала в методе `save_model()`:
```python
class ProductAdmin(admin.ModelAdmin):

    def save_model(self, request, obj, form, change):
    	super().save_model(request, obj, form, change)
    	
        data = form.changed_data

        if any([x in data for x in ['price', 'discount']]):
            price_changed.send(sender=self.__class__, product=obj)

```